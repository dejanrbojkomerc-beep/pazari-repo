<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Pazari po satima</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>Pazari po satima</h2>
  <h3 id="lastReceipt">Poslednji račun u -</h3>

  <label for="dateSelect">Izaberi datum:</label>
  <select id="dateSelect"></select>

  <canvas id="pazarChart" width="800" height="400"></canvas>

  <script>
    let chart;

    async function loadData(){
      try{
        const res = await fetch("data.json?" + Date.now());
        const data = await res.json();

        const select = document.getElementById("dateSelect");
        select.innerHTML = "";
        (data.available_dates || []).forEach(d => {
          const opt = document.createElement("option");
          opt.value = d;
          opt.textContent = d;
          select.appendChild(opt);
        });

        document.getElementById("lastReceipt").textContent =
          "Poslednji račun u " + (data.last_receipt || "-");

        if(select.value){
          renderChart(data, select.value);
        }
        select.onchange = () => renderChart(data, select.value);

      }catch(e){ console.error(e); }
    }

    function renderChart(data, selectedDate){
      const ctx = document.getElementById("pazarChart").getContext("2d");
      const dataset = data.by_date[selectedDate] || {};
      const labels = dataset.hours || [];
      const values = dataset.values || [];

      if(chart){ chart.destroy(); }
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: "Pazar (RSD)",
            data: values,
            backgroundColor: "rgba(75,192,192,0.6)"
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: "Sat" } },
            y: { title: { display: true, text: "Iznos (RSD)" } }
          }
        }
      });
    }

    loadData();
    setInterval(loadData, 300000);
  </script>
</body>
</html>
